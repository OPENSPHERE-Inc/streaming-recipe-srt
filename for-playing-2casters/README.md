# プレイング配信システム（出演者2名分）レシピ

## 0. 前提

本レシピでは、プレイング配信を行う上で、リモートから全出演者が参加する場合の配信システムを構築したいと思います。
今回も SRT という聞きなれないプロトコルを駆使することで、低遅延かつ高品質で信頼性の高いシステムを目指します。

尚、DISCORD、OBS Studio、vMix、その他配信に関する基本的な知識、PCの知識があることを前提とします。

## 1. 要件定義

1. 出演者はゲームに参加し実況プレーするプレイング配信。
2. 出演者が 2 名。それぞれリモートから配信に参加し、お互いにボイスコミュニケーションが可能とする。
3. 配信オペレーターは 1 名、出演者とは別の場所（スタジオ）で配信を実施する。
4. 配信オペレーターからトークバックで出演者に指示を出せる。トークバックは配信には乗せないこと。
5. 出演者 2 名から、それぞれゲーム映像（＋ゲーム音声）と Webcam 映像（＋マイク音声）を受け取って、スタジオで合成して配信する。
6. 出演者 2 名には、Output の絵を返す。
7. 出演者 2 名は自分の配信機材を使用する。運営から特別な機材を用意しない。

## 2. 用意するもの

### 2.1. スタジオ側

* [DISCORD（サーバーも）](https://discord.com/)
* [vMix（HD エディション以上）](https://www.vmix.com/)
* ポートフォーワーディング可能なポート番号 4 つ
* パスワード（10 文字以上 79 文字以下）
* アップロード・ダウンロード共に　100 Mbps 以上出る光インターネット回線

### 2.2. 出演者側

* [DISCORD](https://discord.com/)
* [OBS Studio](https://obsproject.com/)
* Webcam
* その他、出演者がいつも使ってる配信機材
* アップロード・ダウンロード共に　50 Mbps 以上出る光インターネット回線

## 3. システム図

![Picture.14](images/remotework001.jpg?raw=true)

※出演者は DISCORD の画面共有で配信 Output をモニター出来ますが、あくまでも絵の確認用で、画質や低遅延は追及しません。
また、映像のみで Audio はモニターできません。

※ゲーム音とマイク音をパラ（別々）で送るので、vMix 側で音量バランスの調整が出来ます。

## 4. スタジオ側の仕込み

### 4.1. DISCORD の設定

お互いに音声通話しながら仕込みを行うでしょうから、まず DISCORD から準備してください。

[こちらから DISCORD をダウンロード](https://discord.com/)してインストールし、アカウントを作成してログインしてください。
また、専用のサーバーを作成して接続し、招待リンクを生成して出演者側に知らせてください（出演者にサーバーへ接続してもらう）
最後に、音声通話できる様、音声デバイスを設定してボイスチャンネルに参加してください。

尚、配信用の出演者音声は、SRT で送られてきますので、DISCORD の音声は vMix に取り込む必要はありません。

今回のレシピでは、DISCORD の画面共有で 出演者に配信 Output を返します。
こちらについては、vMix の設定の最後で説明します。

### 4.2. ポートフォーワーディングの設定

出演者からは合計4セットの絵音を受け取りますから、ポート番号を4つ決めてください。
ここでは `10001`, `10002`, `10003`, `10004` とします。

出演者A に `10001`（Webcam用）、`10002`（Game用）を、<br />
出演者B に `10003`（Webcam用）、`10003`（Game用）を割り当てるとし、それぞれ出演者に渡してください。<br />

ポート番号を決めたら、SRT を受信するPCに対して UDP でポートフォーワーディングを設定してください。
ポートフォーワーディング設定の仕方は、お使いのブロードバンドルーターのマニュアルを参照するか、ネットワーク担当者に問い合わせてください。

### 4.3. vMix の設定

SRT を受信する Input は4つ必要です。
上記で設定した 4 つのポート番号について、それぞれ「Stream / SRT」で Input を作成してください。
「Add Input」→「Stream / SRT」を開いてください

| 項目                   | 設定値                           |
| -------------------- | ----------------------------- |
| Stream Type          | SRT (Listener)                |
| Port                 | 10001                         |
| Latency (ms)         | 120 ※ここだけ単位がミリ秒なので注意          |
| Decoder Delay (ms)   | 0                             |
| Passphrase           | 10文字以上79文字以下のパスワード。出演者側の OBS Studio に同じものを設定 |
| Key Length           | 変更不要                          |
| Stream ID            | 空欄のまま                         |
| Use Hardware Decoder | チェック入れる                       |

![Picture.2](images/remotework003.jpg?raw=true)

同じ手順で、もう3つ分（10002、10003, 10004）ポート番号を変えて作成してください。

Output を DISCORD から取り込むため、
「Settings」→「External Output」→「External」→「vMix Video / Streaming」にチェックを入れてください。

![Picture.15](images/remotework015.jpg?raw=true)

また、vMix ウインドウの下部にある「External」ボタンを押して、External 出力を有効にしてください。

DISCORD 側では、ビデオ通話を開始し、カメラデバイスとして「vMix Video」を選択すれば、映像を取り込むことが出来ます。
尚、出演者には映像のみ返しますから、Audio は取り込む必要がありません。

![Picture.16](images/remotework016.jpg?raw=true)

> DISCORD に表示された映像が左右反転しますが、これ仕様です。
> 実際は正しい向きの映像が共有されています。
> 本来は Webcam を映す物なので、ユーザビリティの都合で、鏡の様に自分の姿が左右反転します。

## 5. 出演者側の仕込み

### 5.1. DISCORD の設定

お互いに音声通話しながら仕込みを行うでしょうから、まず DISCORD から準備してください。

[こちらから DISCORD をダウンロード](https://discord.com/)してインストールし、アカウントを作成してログインしてください。
本レシピでは、DISCORD は常に OBS Studio と同じ PC にインストールすることを推奨します (\*)。理由と設定方法は後述します。

次に、スタジオ側から送られてきた招待リンクを開いてサーバーに接続し、ボイスチャンネルに参加してください。
また、音声通話できるように音声デバイスを設定しましょう。

DISCORD は出演者間のボイスコミュニケーションと、スタジオからのトークバックにのみ使用します。
原則として DISCORD の音声を配信にミックスしたりはしません。理由としては音質の問題です。

出演者の音声は前述の SRT で、Webcam 映像と共にスタジオまで送信します。
このことで、品質を確保し、映像と音声の同期（リップシンク）を取る手間を省きます。

最後に、ホストが行っている画面共有を視聴し、疎通を確認してください。

---
(\*) 本レシピはあくまでも一例なので、「DISCORD 音を配信に乗せない」という要件を満たせれば、アレンジしても構いません。

### 5.2. OBS Studio の設定

今回は 2 つの OBS Studio インスタンスを使用します。

* **インスタンス 1:** Webcam 映像＋マイク音声
* **インスタンス 2:** ゲーム映像＋ゲーム音声

とします。

#### 5.2.1. インスタンス 1 の設定

今回も顔出し配信を想定していますから、Webcam の映像とマイク音声をスタジオに送信するために、OBS Studio に Webcam と マイク入力を追加してください。

![Picture.5](images/remotework007.jpg?raw=true)

次に配信の設定です。RTMP の代わりに SRT というプロトコルを使用します。
使用するポートは、4.2. で決めたものになりますから、下記の port番号を適時置換してください。

ここでは、Webcam: `10001`, Game: `10002` とします。

1. OBS Studio の「設定」→「配信」→「サービス」を「カスタム...」に変更
2. 「サーバー」に以下のフォーマットで送信先 URL を記入<br />
   srt://`アドレス`:`port番号`?mode=caller&passphrase=`パスワード`&latency=`レイテンシ(μsec)`&pbkeylen=`暗号化キーの長さ`<br />
   例: `srt://192.168.0.10:10001?mode=caller&passphrase=enjoysrt&latency=120000&pbkeylen=16`<br />

![Picture.6](images/remotework008.jpg?raw=true)

3. OBS Studio の「設定」→「出力」→「配信」を以下の様に設定

| 項目                | 設定値                        |
   | ----------------- | -------------------------- |
| 映像ビットレート          | 妥当なビットレート。例: `6000 Kbps`   |
| エンコーダ             | 「ハードウェア」推奨                 |
| 音声ビットレート          | 妥当なビットレートを指定。例： `160 Kbps` |
| 高度なエンコーダの設定を有効にする | チェック入れる                    |
| エンコーダのプリセット       | 「Low-Latency」推奨            |
| エンコーダのカスタム設定      | 空欄のまま                      |

![Picture.7](images/remotework009.jpg?raw=true)

4. 「映像」→「出力（スケーリング）解像度を、適切な解像度に変更。例： `1920x1080`<br />
   「FPS共通値」とし、適切なフレームレートに変更。例： `60`

![Picture.8](images/remotework022.jpg?raw=true)

最後に、「音声ミキサー」で「マイク入力」以外をミュートしてください。
**「デスクトップ音声」を取り込まない様に注意してください**。

![Picture.9](images/remotework006.jpg?raw=true)


1つ目のインスタンスが準備出来たら、「プロファイル」と「シーンコレクション」を保存してください。ここでは「名前を変更」で「Webcam」にリネームします。

![Picture.17](images/remotework018.jpg?raw=true)


#### 5.2.2. インスタンス 2 の設定

インスタンス 1 は起動したままにして、更に OBS Studio を起動してください。
「OBSは既に実行中です」と注意ダイアログが出ますが、「とにかく起動する」ボタンを押して起動してください。

![Picture.18](images/remotework019.jpg?raw=true)

新たなインスタンスが立ち上がりますので、「プロファイル」と「シーンコレクション」で「新規」を実行してください。ここでは名前を「Game」とします。

![Picture.19](images/remotework020.jpg?raw=true)

シーンと配信設定が初期化されるので、インスタンス 2 の設定を行っていきます。

まず、インスタンス 1 と同様に配信設定を行ってください。port番号は Game 用の `10002` とします。

次に、ゲーム画面と音声の取り込みをシーンに入れ込んでください。

![Picture.20](images/remotework021.jpg?raw=true)

ここで、DISCORD 音はゲーム音と共に出演者が聴けなくてはなりませんので、ひと工夫必要になります。
何も考えずに出演者が聴いているゲーム音と DISCORD 音を取り込もうとすると、当然、ゲーム音に DISCORD 音が乗った状態で配信されてしまいます。
これを回避するため、環境に応じて ケースA あるいは ケースB どちらかの対策を講じてください。<br />
**どちらのケースでも、ゲーム音 ＋ Discord 音は OBS Studio の PC から聴く形となります。**

##### ケースA: 1 PC 配信

![Picture.17](images/remotework029.jpg?raw=true)

ここでは、ゲームと OBS Studio が同じ PC という構成を 1 PC 配信と呼称します。
1 PC 配信では 2 つのサウンドデバイスを使用します。
デバイス名は説明の為に使っているもので、実際はお使いのデバイス名に置き換えてください。

- **《サウンドデバイス1》**<br/>
  ゲーム音を再生するデバイスで Windows のサウンド設定で「出力デバイス」に指定
- **《サウンドデバイス2》**<br />
  DISCORD 音を再生するデバイスでヘッドセット（スピーカー）が接続されているデバイス

設定手順は下記の通りです。

1. OBS Studio の「設定」→「音声」→「グローバル音声デバイス」→「デスクトップ音声」に《サウンドデバイス1》を設定
2. 「詳細設定」→「モニタリングデバイス」に《サウンドデバイス2》を設定

![Picture.18](images/remotework025.jpg?raw=true)

3. 「音声ミキサー」→右クリックメニュー→「オーディオの詳細プロパティ」→「デスクトップ音声」→「音声モニタリング」で「モニターと出力」を選択

![Picture.19](images/remotework026.jpg?raw=true)

4.　タスクバーの「🔊アイコン」を右クリック→「サウンドの設定を開く」→「出力サウンドを選択してください」に《サウンドデバイス1》を選択

![Picture.20](images/remotework027.jpg?raw=true)

5. DISCORD の「⚙ユーザー設定」→「音声・ビデオ」→「出力デバイス」を《サウンドデバイス2》に設定

![Picture.21](images/remotework028.jpg?raw=true)

これで《サウンドデバイス2》に接続したヘッドホン（スピーカー）からゲーム音 + DISCORD 音を聴くことが出来ます。

##### ケースB: 2 PC 配信

![Picture.22](images/remotework030.jpg?raw=true)

ここでは、ゲームと OBS Studio が別々の（あるいはゲームコンソールと）PC という構成を、2 PC 配信と呼称します。
2 PC 配信では、1 つのサウンドデバイスだけ使用します。

**《サウンドデバイスX》** は Windows のサウンド設定で「出力デバイス」に指定されており、DISCORD 音が再生され、ヘッドセット（スピーカー）が接続されています。

設定手順は下記の通りです。

1. 「設定」→「音声」→「グローバル音声デバイス」→全部「無効」に設定する
2. 「詳細設定」→「モニタリングデバイス」に《サウンドデバイスX》を設定

![Picture.23](images/remotework031.jpg?raw=true)

3. 「音声ミキサー」→右クリックメニュー→「オーディオ詳細プロパティ」→ゲームのキャプチャデバイス→「音声モニタリング」で「モニターと出力」を選択

![Picture.24](images/remotework032.jpg?raw=true)

4. タスクバーの「🔊アイコン」を右クリック→「サウンドの設定を開く」→「出力サウンドを選択してください」に《サウンドデバイスX》を選択

![Picture.25](images/remotework033.jpg?raw=true)

5. DISCORD の「⚙ユーザー設定」→「音声・ビデオ」→「出力デバイス」を《サウンドデバイスX》に設定

![Picture.26](images/remotework034.jpg?raw=true)

これで《サウンドデバイスX》に接続したヘッドホン（スピーカー）からゲーム音 + DISCORD 音を聴くことが出来ます。

> #### 出演者がアナログミキサーを使用していた場合は？
>
> 出演者が本格的なミキシングコンソール（アナログミキサー）を使って配信環境を構築している場合は、少し話がややこしくなります。
>
> 1. ゲーム音とマイク音はパラで OBS Studio PC に入力する事（可能なら）
> 2. ゲーム音に DISCORD 音を混ぜない事（必須）
> 3. 出演者がゲーム音と DISCORD 音を聴ける事（必須）
> 4. マイク音を DISCORD に入力する事（必須）
>
> 上記の要件を満たすようにセッティングが必要です。
> 最悪、ゲーム音とマイク音が混ざってしまっても（1 の要件が満たせなくても）致命的な問題ではないですが、音量バランスの調整が出演者側でしか行えません。

### 5.3. 疎通確認

全ての設定が済んだら、OBS Studio インスタンス 2 つとも「配信開始」を押して、映像と音声がスタジオ側の vMix に送信されていることを確認してください。

![Picture.27](images/remotework017.jpg?raw=true)

ゲーム画面は特に画質が求められるので、満足な品質が得られているかも確認してください。
必要に応じて（ネットワーク帯域が許すなら）映像のビットレートを上げましょう。

絵音が来ない場合は OBS Studio かスタジオ側の vMix のどちらかの設定がおかしい可能性があります。

また、送信されていても映像が乱れる場合は、出演者宅とスタジオ間の通信状況が良くないので、以下の対策を講じてください。

1. 映像ビットレートを下げる（トレードオフとして画質が悪くなります）
2. latency の値を増やす（トレードオフとして遅延が増えます）<br />
   latency を増やす場合は、全出演者側の OBS Studio とスタジオ側の vMix とで同一の値に設定してください。

通信の状況は vMix ウインドウ右下の「📊Statistics」→「SRT」で確認できます。
以下の RTT が ping 値になりますので、これをもとに Latency の値を見直してください。Packet Loss(%) が　1 % を超える場合は、Latency 値を更に増やす必要があります。

Latency 値は RTT（Ping）値の倍数で設定してください。

![Picture.28](images/remotework024.jpg?raw=true)

![Picture.29](images/remotework023.jpg?raw=true)

### 5.4. 注意点

SRT の latency は全ての OBS Studio で同一の値を使ってください。
また、vMix 側でも同一の時間に設定してください。

つまり、1か所の OBS Studio で latency を増やした場合は、他の OBS Studio も同様に増やさなければならず、vMix 側も同様の時間に設定します。

そうすることにより、絵音のタイミングが大体揃います。

